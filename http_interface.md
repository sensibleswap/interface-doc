# swapServer接口

## 接口地址

- 主网: https://api.tswap.io
- 测试网: https://api.tswap.io/test

## 1. 获取目前支持的所有swap交易对

### Request
- Method: **GET**
- URL: ```/allpairs```

### Response
```
{
    "code":0,
    "data":{
        "bsv-ssp": {
            "token1": {
                "symbol":"bsv",
                "tokenID":"",
                "genesisHash":"",
                "codeHash":"",
                "decimal": 8,
                "rabinApis":[]
            },
            "token2": {
                "symbol":"sspt",
                "tokenID":"2b5c37d535cc7f822022b2bc8ce502c480563de08ec7e7130777cab55337be2100000000",
                "genesisHash":"5de90b9c12d2975a79b67a5f7a2b037f1aad16b0",
                "codeHash":"c9c23794ad9a1899e96482780065c74cf78c3060",
                "decimal": 8,
            },
            "lptoken":{
                "symbol":"bsv-sspt",
                "tokenID":"3aacf8a31dfe2f96a4d5d5e12073db6650a9213c04441ec8bebb49d67b367cf800000000",
                "genesisHash":"02d3ca4f58e216a96a71d43f5af897694ad5fe26",
                "codeHash":"4d4e59d05d38948e12d8015cac9055ba3e41a5bd",
                "decimal":8,
                "rabinApis":["https://s1.satoplay.com","https://satotx.showpay.top","https://satotx.volt.id","https://satotx.metasv.com","https://satotx.tswap.io"]
            },
            "rabinApis":["https://s1.satoplay.com","https://satotx.showpay.top","https://satotx.volt.id","https://satotx.metasv.com","https://satotx.tswap.io"],
            "rabinPubKeys":["1010937066083708988208423350572470881623618068913027023933501065313086545328734310014791554800712436623100745848642805258137673128846642063013893595448111862385207475965651273409987209667095470341564016289859660255112171118611360004905639234212145116192843110365543156485246140770249458363464642357760034518744954243710706182222205344192482134830207331676633275533267511589954664676123927929377393348220912593911067146569842507994848793998056508899004197712248093597114533851676742189190111153106644640700677060257393673501010677189254566975178762187790479406705954190495526678954914559212978700279376663447498824969524252901118056208302145983589250185993637734752914877260585911439376615580199134522671876858995402705793979625676023473873857712715743651681584226994581264464217569036420032498002514759329194856573334812089775672391275008837802178781596174529464602244867066023936505812311202041739487205741473642246082159701","2078299460182638545299035541616293560500538910207835645380047229871216964573778734472341724954602889188966719235712372305812435899184373814580578869303353473606698894126374299777841786102042356495138709295832636978016714832409221403010645764900786981464468681498123985942193582519370255257673318400605121969931179162759397255330474593501541810048094241622513867588022527785523287601470192598327062759532082509643498443162029602386537167370533656067609316818603358418557853247785086814239056452899254722650909095589551559304292375964764603978634621720891569394204900270677009446034920697812672168662577508112500584714045585080674872769810646588072215437703329682603121676979520876244431015048614901244795719579511420988999080700042175423545333667209599150041647137666735365135607089000145052848692898613425327744249913184966722736893976263349383422335778506952003380016552715827342225983399047839624090518970737567504337780149","1324997847845299053401537396101474773937777414211299104572824330956577486586503988300075684888709622807233525878723582130188767982724084154395254568927574920658564796588979595595327610276231989856644263895550815862946010683861629999559166273104690912783356785934791257158920536684222625904614099858202024498330492167871896863244619071962118696147865863895508018904239186079447598749595974227804464108462371736550711341410415063046427944405643371287944894254994846928320897708929855779220305713219941955195134889689620162532570130437044048104340383297952531173882745621870657573057160759443823260730061347249769294104727803595156753908537343670502248451742105357013290759654737629881401586679143756726511588244975712783323388999960390535048828229440784122900988619536213072236257434105868279904245593145822845054863700914881001295745617571589532843156884048852348914389906592985133316264062738714958264711223914361765982847621","586589596411462025024531485980776505996154991448079671367051480833725005347838296489065879114755388083445731693767122440872192989484397225597836453377550046288123328136785932469538000792596657713882587952223588585172440654238463127808515052564839096298200561829030283325577513620973669456877007483575137987286156497887521228342677568300299244433844003583153051356363072749676237147251336389092471291876455430824245119973302036613889183651038007950852722777101717863090345526107715529015606916365154336191455946115308326480985725789124997159269343384759489645333252171821518617113448581681701768769397465437249632138681906977049719059496879287947779604514315693316204728032476075064937164360378078693429364068035756082799219003730854930918595508629017873785400627502199131598836922964360247811059170855014930131381489294712486947767585306490886321780375194874270727670054308682392046094204866097076707011906029229344090291709","3708055592707960689021055876549095432611955499800782125004105687545040847883069893910505598544900596202662264369080002641818414370081808355520028411239888787918276257888620644267788178470005696000307586724331014789899903629900674078570283302018536335744321494498358569820248967544555795386471374395298301819969816063181743888516159502853889282283869480557935821810228651964829782598974476093068421793679411609364679922765211603836650690882866809008414798471461984948913517059330011140546167274193258932750944410891586998718523172773133842227937889894058815130172967641607592869141835778456412148524797703691217380573870281446026049867364072477089153741235162218872642485363685197330144212134658362366582999132709049851496959408928778981302372881815889232055098229416960159873603385531200418123709103096365921675071588222125153532527460672258978819341285289872624010575245577794580699445764721860389565696920456144049232678997"]
        }
    }
}
```

code为0时，表示正常返回data。code为1时，表示由错误。错误信息在msg中。lptoken是在添加流动性时获得的token。在提取流动性时需要将此流动性token返回。rabinApis是签名请求的api地址，rabinPubKeys是签名器对应的rabin公钥。

## 2. 获取swap信息

### Request
- Method: **GET**
- URL: ```/swapinfo?symbol=bsv-ssp```

> * symbol: swap池的符号，/allpairs接口获得。

### Response
```
{
    code: 0,
    message: "",
    data: {
        swapToken1Amount: "100000",
        swapToken2Amount: "100000",
        swapLpAmount: "100000",
        swapFeeRate: 25,
        projFeeRate: 5,
    }
}
```

code为0时，表示正常返回data。code为1时，表示由错误。错误信息在msg中。

data格式如下：

> * swapToken1Amount: swap池中token1即bsv的总数量, 类型为BigInt.toString()
> * swapToken2Amount: swap池中token2即ssp的总数量，类型为BigInt.toString()
> * swapLpAmount: swap池中lp token的总数量, 类型为BigInt.toString()
> * swapFeeRate: swap池进行交换时的收取的总费率
> * projFeeRate: swap池进行交换时收取的项目费率

## 3. 请求swap操作

在进行swap的时候先去请求最新的数据，然后在进行具体的swap操作

### Request

- Method: **POST**

- URL: ```/reqswapargs```

- Body:
```
{
    symbol: "bsv-ssp",
    address: "msREe5jsynP65899v1KJCydf6Sc9pJPb8S",
    op: 1,
    source: 'tswap.io'
}
```

> * symbol: swap池的符号，由swap池中两个代币符号链接而成，token1-token2。
> * address: 操作者用于接受token和bsv的地址
> * op: swap操作。1 增加流动性，2 提取流动性，3 使用token1换取token2，4 使用token2换取token1
> * source: 标记调用者的身份，方便查找错误

### Response
```
{
    code: 0,
    msg: "",
    data: {
        requestIndex: "1", 
        tokenToAddress: "msREe5jsynP65899v1KJCydf6Sc9pJPb8S", 
        bsvToAddress: "mzJR1zKcZCZvMJj87rVqmFFxmaVEe62BBW", 
        txFee: 10000, 
        swapToken1Amount: "100000", 
        swapToken2Amount: "1000000", 
        swapLpAmount: "1000000",
        swapFeeRate: 25,
        projFeeRate: 5,
        op: 1
    },
}
```
code为0时，表示正常返回data。code为1时，表示由错误。错误信息在msg中。**注意每次进行swap操作是都需要申请新的requestIndex，requestIndex不能重复使用。**

data格式如下：

> * requestIndex: 请求编号
> * tokenToAddress: 需要转入token到swap池中的地址
> * bsvToAddress: 需要转入的矿工费以及bsv到如下地址
> * txFee: 此操作需要到矿工费
> * swapToken1Amount: swap池中token1即bsv的总数量, 类型为BigInt.toString()
> * swapToken2Amount: swap池中token2即ssp的总数量，类型为BigInt.toString()
> * swapLpAmount: swap池中lp token的总数量, 类型为BigInt.toString()
> * swapFeeRate: swap池进行交换时的收取的总费率
> * projFeeRate: swap池进行交换时收取的项目费率
> * op: swap操作类型

## 4. 增加流动性

### Request
- Methos: **POST**
- URL: ```/addliq```
- Body: 
```
{
    symbol: "ssp-bsv",
    requestIndex: "1",
    token1TxID: "ea3ddf0825481df5b0c8cac56c2ffd5d8919397eaf169b8204d4e4ead82735b3",
    token1OutputIndex: 1,
    token2TxID: "ea3ddf0825481df5b0c8cac56c2ffd5d8919397eaf169b8204d4e4ead82735b3",
    token2OutputIndex: 1,
    token1AddAmount: "100000",
}
```

> * symbol: swap池的符号，由swap池中两个代币符号链接而成，token1-token2。
> * requestIndex: 之前通过reqswapargs获取的编号。
> * token1TxID: bsv转账tx的id。
> * token1OutputIndex: bsv转账tx的outputIndex。
> * token2TxID: token转账tx的id。
> * token2OutputIndex: token转账tx的outputIndex。
> * token1AddAmount: 往swap池中添加的token1的数量, 类型为BigInt.toString()

**注意：这里转账的bsv数量为txFee + token1AddAmount, token1为bsv时， token1AddAmount不能小于1000 satoshi.**

### Response
```
{
    "code": 0,
    "msg": "",
    "data": "ea3ddf0825481df5b0c8cac56c2ffd5d8919397eaf169b8204d4e4ead82735b3"
}
```
code为0时，表示正常返回data, 其值为swap操作的txid。code为1时，表示由错误。错误信息在msg中。

## 5. 提取流动性

### Request
- Methos: **POST**
- URL: ```/removeliq```
- Body: 
```
{
    symbol: "bsv-ssp",
    requestIndex: "1",
    lpTokenTxID: "ea3ddf0825481df5b0c8cac56c2ffd5d8919397eaf169b8204d4e4ead82735b3",
    lpTokenOutputIndex: 1,
    minerFeeTxID: "ea3ddf0825481df5b0c8cac56c2ffd5d8919397eaf169b8204d4e4ead82735b3",
    minerFeeTxOutputIndex: 0,
}
```

> * symbol: swap池的符号，由swap池中两个代币符号链接而成，token1-token2。
> * requestIndex: 之前通过reqswapargs获取的编号。
> * lpTokenTxID: lpToken转账tx的id。
> * lpTokenOutputIndex: lpToken转账tx的outputIndex。
> * minerFeeTxID: 矿工费转账tx的id。
> * minerFeeTxOutputIndex: 矿工费转账tx的outputIndex。

### Response
```
{
    "code": 0,
    "msg": "",
    "data": "ea3ddf0825481df5b0c8cac56c2ffd5d8919397eaf169b8204d4e4ead82735b3"
}
```
code为0时，表示正常返回data, 其值为swap操作的txid。code为1时，表示由错误。错误信息在msg中。

## 6. 交换token1到token2

把token1交换为token2

### Request
- Method: **POST**
- URL: ```/token1totoken2```
- Body: 
```
{
    symbol: "bsv-ssp",
    requestIndex: "1"
    token1TxID: "ea3ddf0825481df5b0c8cac56c2ffd5d8919397eaf169b8204d4e4ead82735b3",
    token1OutputIndex: 1,
    token1AddAmount: "100000",
}
```
> * symbol: swap池的符号，由swap池中两个代币符号链接而成，token1-token2。
> * requestIndex: 之前通过reqswapargs获取的编号。
> * token1TxID: bsv转账tx的id。
> * token1OutputIndex: bsv转账tx的outputIndex。
> * token1AddAmount: 需要交换的token1(bsv)的数量, 类型为BigInt.toString()

注意：这里转账的bsv数量为txFee + token1AddAmount

### Response
```
{
    "code": 0,
    "msg": "",
    "data": "ea3ddf0825481df5b0c8cac56c2ffd5d8919397eaf169b8204d4e4ead82735b3"
}
```
code为0时，表示正常返回data, 其值为swap操作的txid。code为1时，表示由错误。错误信息在msg中。

## 7. 交换token2到token1

把token2交换为token1

### Request
- Method: **POST**
- URL: ```/token2totoken1```
- Body:
```
{
    symbol: "bsv-ssp",
    requestIndex: "1"
    token2TxID: "ea3ddf0825481df5b0c8cac56c2ffd5d8919397eaf169b8204d4e4ead82735b3",
    token2OutputIndex: 1,
    minerFeeTxID: "ea3ddf0825481df5b0c8cac56c2ffd5d8919397eaf169b8204d4e4ead82735b3",
    minerFeeTxOutputIndex: 0,
}
```
> * symbol: swap池的符号，由swap池中两个代币符号链接而成，token1-token2。
> * requestIndex: 之前通过reqswapargs获取的编号。
> * token2TxID: token2转账tx的id。
> * token2OutputIndex: token2转账tx的outputIndex。
> * minerFeeTxID: 矿工费转账tx的id。
> * minerFeeTxOutputIndex: 矿工费转账tx的outputIndex。

### Response
```
{
    "code": 0,
    "msg": "",
    "data": "ea3ddf0825481df5b0c8cac56c2ffd5d8919397eaf169b8204d4e4ead82735b3"
}
```
code为0时，表示正常返回data, 其值为swap操作的txid。code为1时，表示由错误。错误信息在msg中。

# swap请求流程

- 1. 用户发起请求: 调用```/reqswapargs```，服务器会根据用户传入的```address```，动态生成的需要转入token的合约地址```tokenToAddress```，以及随机生成bsv的转入地址```bsvToAddress```。
- 2. 收到响应后根据返回的参数，计算要转账的token1(bsv)和token2数量，然后将token1转入返回参数```bsvToAddress```，将token2转入返回参数```tokenToAddress```
- 3. 转账完成后，根据不同的操作，请求swap操作接口```/addliq```, ```/removeliq```, ```/token1totoken2```, ```/token2totoken1```
